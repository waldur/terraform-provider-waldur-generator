{{- /* Helper: Convert Terraform value to Go interface{} (for lists) */ -}}
{{- define "tfListToGo" -}}
{{- if eq .ItemType "string" }}
var items{{ .Suffix }} []interface{}
for _, elem := range data.{{ .FieldName }}.Elements() {
	if strVal, ok := elem.(types.String); ok {
		items{{ .Suffix }} = append(items{{ .Suffix }}, strVal.ValueString())
	}
}
{{- else if eq .ItemType "integer" }}
var items{{ .Suffix }} []interface{}
for _, elem := range data.{{ .FieldName }}.Elements() {
	if intVal, ok := elem.(types.Int64); ok {
		items{{ .Suffix }} = append(items{{ .Suffix }}, intVal.ValueInt64())
	}
}
{{- else if eq .ItemType "object" }}
var items{{ .Suffix }} []interface{}
for _, elem := range data.{{ .FieldName }}.Elements() {
	if objVal, ok := elem.(types.Object); ok {
		objMap := make(map[string]interface{})
		for key, attr := range objVal.Attributes() {
			switch v := attr.(type) {
			case types.String:
				objMap[key] = v.ValueString()
			case types.Int64:
				objMap[key] = v.ValueInt64()
			case types.Bool:
				objMap[key] = v.ValueBool()
			case types.Float64:
				objMap[key] = v.ValueFloat64()
			}
		}
		items{{ .Suffix }} = append(items{{ .Suffix }}, objMap)
	}
}
{{- end }}
{{- end -}}

{{- define "mapResponseFields" }}
	// Map response fields to data model
	_ = sourceMap
	{{- range .ModelFields }}
	{{- if ne .Name "name" }}
	if val, ok := sourceMap["{{ .Name }}"]; ok && val != nil {
		{{- if or (eq .Name "project") (eq .Name "offering") }}
		if str, ok := val.(string); ok {
			// Normalize URL to UUID
			parts := strings.Split(strings.TrimRight(str, "/"), "/")
			uuid := parts[len(parts)-1]
			data.{{ .Name | title }} = types.StringValue(uuid)
		}
		{{- else if eq .Type "string" }}
		if str, ok := val.(string); ok {
			data.{{ .Name | title }} = types.StringValue(str)
		}
		{{- else if eq .Type "integer" }}
		if num, ok := val.(float64); ok {
			data.{{ .Name | title }} = types.Int64Value(int64(num))
		}
		{{- else if eq .Type "boolean" }}
		if b, ok := val.(bool); ok {
			data.{{ .Name | title }} = types.BoolValue(b)
		}
		{{- else if eq .Type "number" }}
		if num, ok := val.(float64); ok {
			data.{{ .Name | title }} = types.Float64Value(num)
		}
		{{- else if eq .Type "array" }}
		{{- if eq .ItemType "string" }}
		// List of strings (or flattened objects)
		if arr, ok := val.([]interface{}); ok {
			items := make([]attr.Value, 0, len(arr))
			for _, item := range arr {
				if str, ok := item.(string); ok {
					items = append(items, types.StringValue(str))
				} else if obj, ok := item.(map[string]interface{}); ok {
					// Flattening logic: extract URL or UUID
					if url, ok := obj["url"].(string); ok {
						parts := strings.Split(strings.TrimRight(url, "/"), "/")
						uuid := parts[len(parts)-1]
						items = append(items, types.StringValue(uuid))
					} else if uuid, ok := obj["uuid"].(string); ok {
						items = append(items, types.StringValue(uuid))
					} else if name, ok := obj["name"].(string); ok {
						items = append(items, types.StringValue(name))
					}
				}
			}
			listVal, _ := types.ListValue(types.StringType, items)
			data.{{ .Name | title }} = listVal
		}
		{{- else if eq .ItemType "object" }}
		// List of objects
		if arr, ok := val.([]interface{}); ok {
			items := make([]attr.Value, 0, len(arr))
			for _, item := range arr {
				if objMap, ok := item.(map[string]interface{}); ok {
					attrTypes := map[string]attr.Type{
						{{- range .ItemSchema.Properties }}
						"{{ .TFSDKName }}": {{ toAttrType . }},
						{{- end }}
					}
					attrValues := map[string]attr.Value{
						{{- range .ItemSchema.Properties }}
						{{- if eq .Type "string" }}
						"{{ .TFSDKName }}": types.StringValue(objMap["{{ .Name }}"].(string)),
						{{- else if eq .Type "integer" }}
						"{{ .TFSDKName }}": types.Int64Value(int64(objMap["{{ .Name }}"].(float64))),
						{{- else if eq .Type "boolean" }}
						"{{ .TFSDKName }}": types.BoolValue(objMap["{{ .Name }}"].(bool)),
						{{- else if eq .Type "number" }}
						"{{ .TFSDKName }}": types.Float64Value(objMap["{{ .Name }}"].(float64)),
						{{- else }}
						"{{ .TFSDKName }}": types.StringNull(),
						{{- end }}
						{{- end }}
					}
					objVal, _ := types.ObjectValue(attrTypes, attrValues)
					items = append(items, objVal)
				}
			}
			listVal, _ := types.ListValue(types.ObjectType{AttrTypes: map[string]attr.Type{
				{{- range .ItemSchema.Properties }}
				"{{ .TFSDKName }}": {{ toAttrType . }},
				{{- end }}
			}}, items)
			data.{{ .Name | title }} = listVal
		}
		{{- end }}
		{{- else if eq .Type "object" }}
		// Nested object
		if objMap, ok := val.(map[string]interface{}); ok {
			attrTypes := map[string]attr.Type{
				{{- range .Properties }}
				"{{ .TFSDKName }}": {{ toAttrType . }},
				{{- end }}
			}
			attrValues := map[string]attr.Value{
				{{- range .Properties }}
				{{- if eq .Type "string" }}
				"{{ .TFSDKName }}": types.StringValue(objMap["{{ .Name }}"].(string)),
				{{- else if eq .Type "integer" }}
				"{{ .TFSDKName }}": types.Int64Value(int64(objMap["{{ .Name }}"].(float64))),
				{{- else if eq .Type "boolean" }}
				"{{ .TFSDKName }}": types.BoolValue(objMap["{{ .Name }}"].(bool)),
				{{- else if eq .Type "number" }}
				"{{ .TFSDKName }}": types.Float64Value(objMap["{{ .Name }}"].(float64)),
				{{- else }}
				"{{ .TFSDKName }}": types.StringNull(),
				{{- end }}
				{{- end }}
			}
			objVal, _ := types.ObjectValue(attrTypes, attrValues)
			data.{{ .Name | title }} = objVal
		}
		{{- end }}
	} else {
		if data.{{ .Name | title }}.IsUnknown() {
			{{- if eq .Type "string" }}
			data.{{ .Name | title }} = types.StringNull()
			{{- else if eq .Type "integer" }}
			data.{{ .Name | title }} = types.Int64Null()
			{{- else if eq .Type "boolean" }}
			data.{{ .Name | title }} = types.BoolNull()
			{{- else if eq .Type "number" }}
			data.{{ .Name | title }} = types.Float64Null()
			{{- else if eq .Type "array" }}
			{{- if eq .ItemType "string" }}
			data.{{ .Name | title }} = types.ListNull(types.StringType)
			{{- else if eq .ItemType "integer" }}
			data.{{ .Name | title }} = types.ListNull(types.Int64Type)
			{{- else if eq .ItemType "boolean" }}
			data.{{ .Name | title }} = types.ListNull(types.BoolType)
			{{- else if eq .ItemType "number" }}
			data.{{ .Name | title }} = types.ListNull(types.Float64Type)
			{{- else if eq .ItemType "object" }}
			data.{{ .Name | title }} = types.ListNull(types.ObjectType{AttrTypes: map[string]attr.Type{
				{{- range .ItemSchema.Properties }}
				"{{ .TFSDKName }}": {{ toAttrType . }},
				{{- end }}
			}})
			{{- end }}
			{{- else if eq .Type "object" }}
			data.{{ .Name | title }} = types.ObjectNull(map[string]attr.Type{
				{{- range .Properties }}
				"{{ .TFSDKName }}": {{ toAttrType . }},
				{{- end }}
			})
			{{- end }}
		}
	}
	{{- end }}
	{{- end }}
{{- end }}


{{- define "mockResponseJSON" }}
{
	"uuid": "%s"{{- if gt (len .ModelFields) 0 }},{{- end }}
	{{- range $i, $field := .ModelFields }}
	{{- if ne $field.Name "uuid" }}
	{{- if $field.ReadOnly }}
	{{- if eq $field.Type "string" }}
	"{{ $field.Name }}": "dummy-{{ $field.Name }}"{{ if ne $i (sub (len $.ModelFields) 1) }},{{ end }}
	{{- else if eq $field.Type "integer" }}
	"{{ $field.Name }}": 123{{ if ne $i (sub (len $.ModelFields) 1) }},{{ end }}
	{{- else if eq $field.Type "boolean" }}
	"{{ $field.Name }}": true{{ if ne $i (sub (len $.ModelFields) 1) }},{{ end }}
	{{- else if eq $field.Type "array" }}
	{{- if eq $field.ItemType "string" }}
	"{{ $field.Name }}": ["tag1", "tag2"]{{ if ne $i (sub (len $.ModelFields) 1) }},{{ end }}
	{{- end }}
	{{- end }}
	{{- else }}
	{{- if eq $field.Type "string" }}
	"{{ $field.Name }}": "%s"{{ if ne $i (sub (len $.ModelFields) 1) }},{{ end }}
	{{- else if eq $field.Type "integer" }}
	"{{ $field.Name }}": %d{{ if ne $i (sub (len $.ModelFields) 1) }},{{ end }}
	{{- else if eq $field.Type "boolean" }}
	"{{ $field.Name }}": %t{{ if ne $i (sub (len $.ModelFields) 1) }},{{ end }}
	{{- end }}
	{{- end }}
	{{- end }}
	{{- end }}
}
{{- end }}
